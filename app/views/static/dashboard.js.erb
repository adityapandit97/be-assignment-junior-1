<script>
  document.addEventListener('DOMContentLoaded', function() {
  const addUserButton = document.getElementById('addUserButton');
  const dynamicFieldsContainer = document.getElementById('dynamicFieldsContainer');
  const shareEquallyCheckbox = document.getElementById('sharedEqually1');
  const amountInput = document.getElementById('expenseAmount');
  let counter = 1;
  const users = <%= raw @user_friends.to_json %>;
  const currentUserId = <%= raw current_user.id %>;

  function updateAmountFields() {
    const totalUsers = dynamicFieldsContainer.querySelectorAll('select').length + 1;
    if (shareEquallyCheckbox.checked && totalUsers > 0) {
      const amountPerUser = parseFloat(amountInput.value) / totalUsers;
      dynamicFieldsContainer.querySelectorAll('input[type="number"]').forEach(input => {
        input.value = amountPerUser.toFixed(2);
      });
    }
  }

  shareEquallyCheckbox.addEventListener('change', updateAmountFields);

  amountInput.addEventListener('input', updateAmountFields);

  addUserButton.addEventListener('click', () => {
    const newUserInput = document.createElement('select');
    newUserInput.name = `expense_share[${counter}][user]`;
    newUserInput.classList.add('form-select');
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.name;
      newUserInput.appendChild(option);
    });

    const newAmountInput = document.createElement('input');
    newAmountInput.type = 'number';
    newAmountInput.name = `expense_share[${counter}][amount]`;
    newAmountInput.classList.add('form-control');

    const removeButton = document.createElement('button');
    removeButton.textContent = 'Remove User'; // Cross emoji for remove button
    removeButton.type = 'button';
    removeButton.classList.add('btn','btn-sm','my-2', 'btn-danger');
    removeButton.addEventListener('click', () => {
      newUserInput.remove();
      newAmountInput.remove();
      removeButton.remove();
      updateAmountFields();
    });

    dynamicFieldsContainer.appendChild(newUserInput);
    dynamicFieldsContainer.appendChild(newAmountInput);
    dynamicFieldsContainer.appendChild(removeButton);

    counter++;

    if (shareEquallyCheckbox.checked) {
      updateAmountFields();
    }
  });
});

</script>